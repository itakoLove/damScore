<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>DAMスコア</title>
		<script>
			const url = new URL(location.href);
			let sendUrl = 'https://damscore-back.to8823.workers.dev/api/get/user';
			const xhr = new XMLHttpRequest();
			xhr.open("GET", sendUrl);
			xhr.send();

			xhr.onreadystatechange = (e) => {
				if (xhr.readyState === XMLHttpRequest.DONE) {
					const status = xhr.status;
					if (status === 0 || (status >= 200 && status < 400)) {
						const userList = JSON.parse(xhr.responseText);

						const ce = a => document.createElement(a);
						let tableElem = document.querySelector('#table1 tbody');

						for (let user of userList) {
							let userElem = ce('tr');
							
							let imgTdElem = ce('td');
							let imgElem = ce('div');
							imgElem.style.backgroundImage = 'url(https://www.clubdam.com/app/contents/prof/user_images/4/' + user.damtomoId + '.jpg?time=' + new Date().getTime() + ')';
							imgElem.className = 'frame';
							imgTdElem.appendChild(imgElem);
							userElem.appendChild(imgTdElem);
							
							let nameElem = ce('td');
							nameElem.innerText = user.name;
							userElem.appendChild(nameElem);
							//let nameElem = ce('label');
							//nameElem.innerText = user.name;
							//imgTdElem.appendChild(nameElem);
							
							let countElem = ce('td');
							countElem.innerText = user.count;
							countElem.className = 'right';
							userElem.appendChild(countElem);

							let maxTotalPointsElem = ce('td');
							maxTotalPointsElem.innerText = (user.maxTotalPoints/1000).toFixed(3);
							maxTotalPointsElem.className = 'right';
							userElem.appendChild(maxTotalPointsElem);

							//maxScoringDateTime
							let maxScoringDateTimeElem = ce('td');
							let msdt = user.maxScoringDateTime;
							maxScoringDateTimeElem.innerText = msdt.substr(0,4) + '/' + msdt.substr(4,2) + '/' + msdt.substr(6,2) + ' ' + msdt.substr(8,2) + ':' + msdt.substr(10,2) + ':' + msdt.substr(12,2);
							maxScoringDateTimeElem.className = 'datetime';
							userElem.appendChild(maxScoringDateTimeElem);


							let linkElem = ce('td');
							let scoreListElem = ce('a');
							scoreListElem.href = 'score.html?clubdamcardno=' + user.cdmCardNo;
							scoreListElem.innerText = '採点一覧を見る';
							linkElem.appendChild(scoreListElem);
							
							linkElem.appendChild(ce('br'));
							
							let damtomoLinkElem = ce('a');
							damtomoLinkElem.href = 'https://www.clubdam.com/app/damtomo/member/info/Profile.do?damtomoId=' + user.damtomoId;
							damtomoLinkElem.target = 'blank';
							damtomoLinkElem.innerText = 'DAMともを見る';
							linkElem.appendChild(damtomoLinkElem);

							userElem.appendChild(linkElem);
							
							tableElem.appendChild(userElem);
						}
						
						// document.querySelector('#list1').appendChild(tableElem);

					}
				}
			}

		</script>
		<link href="main.css" rel="stylesheet" />
		<link href="index.css" rel="stylesheet" />
	</head>
	<body>
		<h1>DAMスコア</h1>

		<p><a href="javascript:(()=>{let id='damscore_script';if(document.querySelector('#'+id)===null){let s=document.createElement('script');s.id=id;s.src='https://itakolove.github.io/damScore/bookmarklet.js?time='+new Date().getTime();s.onload=()=>damScore.start();document.body.appendChild(s);}else{damScore.start();}})();">こちらをブックマークにD&D</a></p>
		
		<table id="table1">
			<tr>
				<th colspan="2">名前</th>
				<th>採点回数</th>
				<th>最高得点</th>
				<th>最後に歌った日時</th>
				<th>リンク</th>
			</tr>
		</table>
	</body>
</html>
